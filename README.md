# Introduction

This project acts as reference implementation of main aspects of an e-prescription server designed by gematik.

Specifications of e-prescription application (E-Rezept, eRp) are published at
[Gematik Fachportal](https://fachportal.gematik.de/spezifikationen/online-produktivbetrieb/konzepte-und-spezifikationen/)

This implementation follows "Spezifikation E-Rezept Fachdienst" \[gemSpec\_FD\_eRP\] specification
available in specification bundle at location above. Additionally it follows further specifications
referenced by \[gemSpec\_FD\_eRP\].

This server offers a FHIR interface according to [HL7 FHIR](https://hl7.org/FHIR/) standard,
profiled to e-prescription needs. Profiling information are available at
[Simplifier](https://simplifier.net/erezept-workflow/).

In order to run the server in a trusted execution environment (VAU), it also implements a separate
protocol on top of http (eRp VAU protocol).

To get an overview about the server API we recommend reading [API description](https://github.com/gematik/api-erp).

# Limitations

There are limitations to this implementation as currently some parts are not implemented.
Following functionality is available:

-   REST server basics

-   eRp VAU protocol encryption and decryption

-   FHIR server basics:

    -   Capability Statement generation

    -   XML and JSON serialization and deserialization

    -   \_format parameter handling for Capability Statement

-   FHIR resources and operations

    -   Task resource

        -   read interaction

        -   $create operation

        -   $activate operation

    -   Communication resource

        -   create interaction

        -   read interaction

        -   delete interaction

-   access code generation

-   separate interfaces for eRp-App (FdV) and medical suppliers/pharmacies (LE)

-   Access token validation

-   Download and provide endpoints for TSL (Trust Status List)

There is no complete workflow implemented just now. It is intended as an very early release.

# License

Copyright (c) 2020 gematik GmbH

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

<http://www.apache.org/licenses/LICENSE-2.0>

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

# Overview

E-prescription server is a central part of e-prescription application and acts as a backend service
of e-prescription App as well as a central service of practitioner’s medical practice
administration systems and pharmacy’s administration systems.

To get an overview following picture depicts the system context and some
inner components of e-prescription server.

![system context overview](doc/images/system_context_overview.png)

# Getting started

## Rust Toolchain

To build the ref-erx-fd-server you need the [Rust](https://www.rust-lang.org)
Toolchain. To setup the Toolchain follow [this instructions](https://www.rust-lang.org/learn/get-started).

## Dependencies

The ref-erx-fd-server has dependencies to external libraries listed below.

-   [OpenSSL](https://www.openssl.org) - OpenSSL is used to encrypt and decrypt requests
    send to the service. Please make sure you also have installed the development dependencies
    of OpenSSL. You will need at least openssl v1.1.1.

    -   On linux you can install the depdendencies using the following command

            $ apt-get install libssl1.1 libssl-dev

    -   On windows you can download the OpenSSL binaries from [this website](https://wiki.openssl.org/index.php/Binaries).
        Additionally you need to specify the following environment variables:

            OPENSSL_DIR = <path-to-openssl>
            OPENSSL_LIB_DIR = <path-to-openssl>/lib
            OPENSSL_INCLUDE_DIR = <path-to-openssl>/include

## Build the Project

After you have successfully installed the Rust toolchain you can build the
project by invoking the following command.

    $ cargo build

## Generating Credentials

The service needs serveral keys to operate correctly:

-   FD keypair - key pair for the service

-   IDP keypair - key pair of the IDP service to generate access tokens
    (this is only for testing purposes, the actual access tokens are generated by the IDP service).

The cryptographic algorithms used in this example may change in the future.

To generate the needed key you can use the following Open SSL commands:

    # Generate private key for the service
    $ openssl ecparam -name brainpoolP256r1 -genkey -noout -out fd_id

    # Extract public key
    $ openssl pkey -in fd_id -out fd_id.pub -pubout

    # Create X509 certificate
    $ openssl req -new -key fd_id > cert.csr
    $ openssl x509 -in cert.csr -out fd.cert -req -signkey fd_id -days 1001

    # Generate private key for the IDP service (only used for access token generation)
    $ openssl ecparam -name prime256v1 -genkey -noout -out idp_id

    # Extract public key
    $ openssl pkey -in idp_id -out idp_id.pub -pubout

You can than use the official [JWT tool](https://jwt.io/) to generate a ES265 access token
with the generated IDP key pair and the following claims:

    {
        "acr": "1",
        "aud": "https://erp.telematik.de/login",
        "exp": 2524608000,
        "family_name": "Mustermann",
        "given_name": "Max",
        "iat": 1585336956,
        "idNummer": "X123456789",
        "iss": "https://idp1.telematik.de/jwt",
        "jti": "<IDP>_01234567890123456789",
        "nbf": 1585336956,
        "nonce": "fuu bar baz",
        "organizationName": "Institutions- oder Organisations-Bezeichnung",
        "professionOID": "1.2.276.0.76.4.49",
        "sub": "RabcUSuuWKKZEEHmrcNm_kUDOW13uaGU5Zk8OoBwiNk"
    }

## Run the Service

To run the service use the following command line. The service needs a
private key and X.509 certificate for the VAU encryption. These two parameters
are mandatory.

    $ cargo run -p ref-erx-fd-server -- \
        --key ./path/to/fd_id \
        --cert ./path/to/fd.cert \
        --token file://path/to/idp_id.pub \
        --tsl https://download.tsl.ti-dienste.de

For testing purposes you can use the TSL that is provided by the specified URL. In the final product you should use your own TSL endpoint!

To get a full list of all supported parameters use

    $ cargo run -p ref-erx-fd-server -- --help

You can also execute the binary of the service directly without using cargo.
The binary can be found in the target directory

    $ ./ref-erx-fd-server --help
